{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <link rel="stylesheet" type="text/css" href="{% static 'main/view/css/PanoControls.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'main/view/css/panoviewer.css' %}"/>
    <script src="{% static 'main/view/js/jquery-2.2.4.js' %}"></script>
    <script src="{% static 'main/view/js/view360.pkgd.js' %}"></script>
    <script src="{% static 'main/view/js/PieView.js' %}"></script>
    <script src="{% static 'main/view/js/PanoControls.js' %}"></script>
    <style>
        .annotation-pos {
            cursor: pointer;
            position: absolute;
        }

        .annotation-pos .annotation-pos-icon {
            width: 12.5px;
            height: 12.5px;
            background-color: rgb(0, 223, 252);
            border-radius: 50%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 10px;
            border: 1px solid #888;
            width: 40%;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .switch-view-btn {
            position: fixed;
            left: 5%;
            top: 5%;
            font-size: 15px;
            z-index: 1;
        }
    </style>
</head>
<body>
<div class="viewer">
    {% if object.spinviewer %}
        <button class="switch-view-btn"
                onclick="window.location='{% url 'view_spinviewer' object.organization.api_key object.uuid %}'">
            Spinviewer
        </button>
    {% endif %}
    <div class="container"></div>
    <div id="annotation-modal" class="modal">
        <div class="modal-content">
            <span class="close annotation-modal-close">&times;</span>
            <h4 class="annotation-title"
                style="text-align: center;padding: 2px;margin-top:5px;margin-bottom: 10px;"></h4>
            <img class="annotation-image" style="width: 100%;max-height: 12vmax;">
            <h6 class="annotation-description"
                style="font-size: 15px;padding: 4px;text-align: center;margin-top:5px;margin-bottom: 5px;"></h6>
        </div>
    </div>
</div>
</body>
<script>
    var panoviewer = document.querySelector('.viewer');
    var container = document.querySelector('.viewer .container');
    var annotations = {{ annotations|safe }};
    var media_prefix = "{%  get_media_prefix %}";

    function toRadian(deg) {
        return (deg * Math.PI) / 180;
    }

    function toAngle(rad) {
        return (rad * 180) / Math.PI;
    }

    function getHFov(fov) {
        var rect = container.getBoundingClientRect();
        var width = rect.width;
        var height = rect.height;
        return ((Math.atan((width / height) * Math.tan(toRadian(fov) / 2)) / Math.PI) * 360);
    }

    function rotate(point, deg) {
        var rad = toRadian(deg);
        var cos = Math.cos(rad);
        var sin = Math.sin(rad);
        return [cos * point[0] - sin * point[1], sin * point[0] + cos * point[1]];
    }

    var viewer = new eg.view360.PanoViewer(container, {
        image: "{%  get_media_prefix %}{{ object.panoviewer_media }}",
        useZoom: false,
        projectionType: eg.view360.PanoViewer.PROJECTION_TYPE.EQUIRECTANGULAR,
        cubemapConfig: {tileConfig: {flipHorizontal: true, rotation: 0},},
    }).on('ready', function (e) {
        viewer.lookAt({fov: 80,});
        setTimeout(function () {
            viewer.lookAt({fov: 65,}, 500);
            renderAnnotations();
        });
    }).on('viewChange', function (e) {
        renderAnnotations();
    }).on('error', (e) => {
        console.error(e);
    });

    window.addEventListener('resize', function (e) {
        viewer.updateViewportDimensions();
    });

    PanoControls.init(panoviewer, viewer);
    PanoControls.showLoading();

    function renderAnnotations() {
        $('.annotation-pos').remove();

        annotations.map(annotation => {
            var oyaw = viewer.getYaw();
            var opitch = viewer.getPitch();
            var yaw = annotation['yaw'];
            var pitch = annotation['pitch'];
            var deltaYaw = yaw - oyaw;
            var deltaPitch = pitch - opitch;

            if (deltaYaw < -180) {
                deltaYaw += 360;
            } else if (deltaYaw > 180) {
                deltaYaw -= 360;
            }

            if (Math.abs(deltaYaw) > 90) {
                return;
            }

            var radYaw = toRadian(deltaYaw);
            var radPitch = toRadian(deltaPitch);

            var fov = viewer.getFov();
            var hfov = getHFov(fov);

            var rx = Math.tan(toRadian(hfov) / 2);
            var ry = Math.tan(toRadian(fov) / 2);

            var point = [Math.tan(-radYaw) / rx, Math.tan(-radPitch) / ry];

            var left = viewer._width / 2 + (point[0] * viewer._width) / 2;
            var top = viewer._height / 2 + (point[1] * viewer._height) / 2;

            $(panoviewer).append(
                `<div class="annotation-pos" data-annotation-id="${annotation.id}" style="transform:translate(${left}px, ${top}px)"><div class="annotation-pos-icon" data-annotation-id="${annotation.id}"/></div>`
            );
        });

        const annotationBtns = $('.annotation-pos');

        window.addEventListener(
            'click',
            function (event) {
                var isAnnotationModal = jQuery('#annotation-modal').length > 0;
                if (
                    isAnnotationModal &&
                    ($(event.target).hasClass('annotation-modal-open') ||
                        $(event.target).hasClass('annotation-modal-header') ||
                        $(event.target).hasClass('annotation-modal-close'))
                ) {
                    event.stopPropagation();
                }

                if ($(event.target).hasClass('annotation-modal-close')) {
                    $(document.body).removeClass('annotation-modal-open');
                    $(`#annotation-modal`).css('display', 'none');
                }
            },
            true
        );

        annotationBtns.on('mousedown', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const annotationId = $(e.target).data('annotation-id');
            showAnnotation(annotationId);
        });

        annotationBtns.on('mouseup', function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        annotationBtns.on('mousedown', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const annotationId = $(e.target).data('annotation-id');
            showAnnotation(annotationId);
        });
    }

    function showAnnotation(annotationId) {
        const annotation = annotations.find(
            (a) => a.id == annotationId
        );

        $('.annotation-title').text(
            annotation['title']
        );

        $('.annotation-image').attr(
            'src',
            annotation['photo']
        );

        $('.annotation-description').text(
            annotation['description']
        );

        $(document.body).addClass('annotation-modal-open');

        $(`#annotation-modal`).css('display', 'block');
    }
</script>
</html>
